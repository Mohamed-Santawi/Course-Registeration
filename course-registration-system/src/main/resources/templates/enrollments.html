<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>My Enrollments - Course Registration System</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
    <style>
      .enrollment-card {
        border-radius: 1.25rem;
        box-shadow: 0 4px 24px rgba(60, 60, 120, 0.1);
        margin-bottom: 1.5rem;
      }
      .enrollment-card .card-header {
        background: #1976d2;
        color: #fff;
        border-radius: 1.25rem 1.25rem 0 0;
      }
      .enrollment-icon {
        font-size: 2rem;
        color: #1976d2;
      }
    </style>
  </head>
  <body class="bg-light d-flex flex-column min-vh-100">
    <div th:replace="~{navbar :: navbar}"></div>
    <div class="container py-5">
      <h1 class="mb-4 text-primary">
        <i class="fas fa-list-check"></i> My Enrollments
      </h1>
      <div
        th:if="${#lists.isEmpty(enrollments)}"
        class="alert alert-info text-center"
      >
        <i class="fas fa-info-circle"></i> You are not enrolled in any courses
        yet.
      </div>
      <div th:if="${!#lists.isEmpty(enrollments)}">
        <table
          class="table table-bordered table-striped shadow animate__animated animate__fadeInUp"
        >
          <thead class="table-primary">
            <tr>
              <th>Course Name</th>
              <th>Course Code</th>
              <th>Semester</th>
              <th>Enrolled On</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="enrollment, iter : ${enrollments}">
              <td th:text="${enrollment.course.title}"></td>
              <td th:text="${enrollment.course.code}"></td>
              <td th:text="${enrollment.course.semester}"></td>
              <td th:text="${enrollment.enrollmentDate}"></td>
              <td>
                <button
                  type="button"
                  class="btn btn-info btn-sm animate__animated animate__pulse"
                  data-bs-toggle="modal"
                  th:attr="data-bs-target='#scheduleModal' + ${iter.index}"
                >
                  <i class="fas fa-calendar-alt"></i> View Lecture Schedule
                </button>
                <button
                  type="button"
                  class="btn btn-danger btn-sm ms-2"
                  th:attr="data-enrollment-id=${enrollment.id}"
                  onclick="unenrollCourse(this)"
                >
                  <i class="fas fa-trash"></i> Remove
                </button>
                <!-- Modal for lecture schedule -->
                <div
                  class="modal fade"
                  th:id="'scheduleModal' + ${iter.index}"
                  tabindex="-1"
                  aria-labelledby="scheduleModalLabel"
                  aria-hidden="true"
                >
                  <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header bg-primary text-white">
                        <h5
                          class="modal-title"
                          th:id="'scheduleModalLabel' + ${iter.index}"
                        >
                          <i class="fas fa-chalkboard-teacher"></i>
                          ðŸ’¼
                          <span
                            th:text="${enrollment.course.programs[0].name}"
                          ></span>
                          Program â€“ (<span
                            th:text="${enrollment.course.title}"
                          ></span
                          >)
                        </h5>
                        <button
                          type="button"
                          class="btn-close"
                          data-bs-dismiss="modal"
                          aria-label="Close"
                        ></button>
                      </div>
                      <div
                        class="modal-body animate__animated animate__fadeInUp"
                      >
                        <table
                          class="table table-bordered table-striped shadow animate__animated animate__fadeInUp"
                        >
                          <thead class="table-info">
                            <tr>
                              <th>Day</th>
                              <th>Start</th>
                              <th>End</th>
                              <th>Location</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr th:each="s : ${enrollment.course.schedules}">
                              <td th:text="${s.dayOfWeek}"></td>
                              <td th:text="${s.startTime}"></td>
                              <td th:text="${s.endTime}"></td>
                              <td
                                th:text="${s.location != null and !#strings.isEmpty(s.location) ? s.location : 'Hall A'}"
                              ></td>
                            </tr>
                            <tr
                              th:if="${#lists.isEmpty(enrollment.course.schedules)}"
                            >
                              <td colspan="4" class="text-muted">
                                No schedule available for this course.
                              </td>
                            </tr>
                          </tbody>
                        </table>
                        <div class="text-end">
                          <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                          >
                            Close
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="text-center mt-4">
        <a th:href="@{/}" class="btn btn-secondary"
          ><i class="fas fa-home"></i> Back to Home</a
        >
      </div>
    </div>
    <footer class="bg-primary text-white text-center py-3 mt-auto">
      <div class="container">
        &copy;
        <span th:text="${#dates.format(#dates.createNow(), 'yyyy')}"></span>
        College Course Registration System
      </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js"></script>
    <script>
      function unenrollCourse(btn) {
        const enrollmentId = btn.getAttribute("data-enrollment-id");
        if (!confirm("Are you sure you want to remove this course?")) return;
        // Get CSRF token and header name from meta tags
        const csrfToken = document
          .querySelector('meta[name="_csrf"]')
          .getAttribute("content");
        const csrfHeader = document
          .querySelector('meta[name="_csrf_header"]')
          .getAttribute("content");
        const headers = { "Content-Type": "application/x-www-form-urlencoded" };
        headers[csrfHeader] = csrfToken;
        fetch("/api/courses/unenroll", {
          method: "POST",
          headers: headers,
          body: "enrollmentId=" + encodeURIComponent(enrollmentId),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              location.reload();
            } else {
              alert(data.error || "Failed to unenroll.");
            }
          });
      }
    </script>
  </body>
</html>
